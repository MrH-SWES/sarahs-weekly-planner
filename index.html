<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BenKenHen Weekly Meal Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* ACRYLIC THEME */
            --bg-dark: #1e1e1e;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            
            /* COLORS */
            --accent-primary: #a7ff83; /* Neon Green/Mint */
            --accent-secondary: #4deeea; /* Neon Blue */
            --accent-warm: #ff7eb3; /* Neon Pink */
            --text-main: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.6);
            
            /* FONTS */
            --font-main: 'Lexend', sans-serif;
            
            --radius: 16px;
        }

        /* --- GLOBAL RESETS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            /* Mesh Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* --- GLASS COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: var(--radius);
        }

        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 20px;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            text-align: center;
            color: var(--accent-secondary);
        }

        /* --- TABS --- */
        .tab-content { display: none; padding: 20px; max-width: 650px; margin: 0 auto; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CONTROLS --- */
        .controls-row { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        
        .pill-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            padding: 8px 18px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-main);
            cursor: pointer;
            white-space: nowrap;
            font-family: var(--font-main);
            transition: 0.2s;
        }
        .pill-btn.active { background: var(--accent-primary); color: #000; border-color: var(--accent-primary); }
        .pill-btn.secondary { border-color: var(--accent-secondary); color: var(--accent-secondary); }

        .action-btn {
            background: var(--accent-primary); color: #1a1a1a; border: none;
            padding: 12px 20px; border-radius: 12px; font-weight: 800;
            font-family: var(--font-main); cursor: pointer; 
            width: 100%; transition: 0.1s;
        }
        .action-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* --- PLANNER SPECIFIC --- */
        .meal-day-card {
            margin-bottom: 20px;
            padding: 0;
            overflow: hidden;
        }

        .meal-day-header {
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid var(--glass-border);
            font-weight: 800;
            font-size: 1rem;
            color: var(--accent-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-slot-row {
            display: flex;
            border-bottom: 1px solid var(--glass-border);
            min-height: 55px;
        }
        .meal-slot-row:last-child { border-bottom: none; }

        .slot-label {
            width: 50px;
            background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--text-muted);
        }

        .slot-content {
            flex: 1;
            padding: 0 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .slot-empty-btn {
            background: none; border: none;
            color: var(--text-muted);
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 15px 0;
        }
        .slot-empty-btn:hover { color: var(--accent-primary); }

        .slot-filled {
            flex: 1;
            cursor: pointer;
            font-weight: 400;
        }
        .slot-filled:hover { text-decoration: underline; color: var(--accent-primary); }

        .slot-clear-btn {
            background: none; border: none; color: var(--accent-warm);
            font-size: 1.2rem; cursor: pointer; padding: 5px;
        }

        /* --- RECIPE CARDS (ACRYLIC STYLE) --- */
        .card-stack-container {
            position: relative; height: 400px; margin: 20px auto; max-width: 380px; perspective: 1000px;
        }
        
        .recipe-card {
            position: absolute; width: 100%; height: 380px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 16px;
            transition: all 0.35s ease-out;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            overflow: hidden;
            left: 50%; transform: translateX(-50%);
        }
        
        .recipe-card[data-pos="0"] { z-index: 20; transform: translateX(-50%) rotate(0deg); opacity: 1; }
        .recipe-card[data-pos="1"] { z-index: 19; transform: translateX(-48%) rotate(3deg); opacity: 0.7; }
        .recipe-card[data-pos="2"] { z-index: 18; transform: translateX(-46%) rotate(6deg); opacity: 0.4; }
        
        .card-content { padding: 25px; height: 100%; overflow: hidden; color: white; }
        .card-title { font-size: 1.6rem; font-weight: 800; margin-bottom: 10px; line-height: 1.2; }
        
        .card-tag { 
            display: inline-block; background: rgba(0,0,0,0.3); 
            border: 1px solid var(--accent-secondary); color: var(--accent-secondary);
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin-right: 5px; margin-bottom: 5px;
        }

        .card-nav { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .card-nav-btn { 
            background: var(--glass-bg); border: 1px solid var(--glass-border); color: white;
            width: 50px; height: 50px; border-radius: 50%; font-size: 1.5rem; cursor: pointer;
        }

        /* --- SHOPPING LIST --- */
        .shop-item {
            display: flex; align-items: center; padding: 15px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s;
        }
        .shop-item.checked { opacity: 0.4; text-decoration: line-through; }
        
        .shop-checkbox {
            width: 22px; height: 22px; border: 2px solid var(--accent-primary);
            border-radius: 6px; margin-right: 15px; flex-shrink: 0;
        }
        .shop-item.checked .shop-checkbox { background: var(--accent-primary); }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px;
            background: rgba(30,30,30,0.9); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 35px;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200;
        }
        
        .nav-btn {
            background: none; border: none; color: var(--text-muted);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            cursor: pointer; font-family: var(--font-main); font-size: 0.7rem; font-weight: 600;
            width: 60px;
        }
        .nav-btn.active { color: var(--accent-secondary); opacity: 1; }
        .nav-icon { font-size: 1.4rem; }
        
        .nav-add-btn {
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--accent-primary); border: none;
            color: #000; font-size: 1.8rem; margin-top: -30px;
            box-shadow: 0 0 15px rgba(167, 255, 131, 0.4);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- MODALS --- */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; 
            align-items: center; justify-content: center; 
        }
        .modal.show { display: flex; }
        
        .modal-card { 
            width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; 
            padding: 25px; color: white;
        }
        
        input, textarea {
            width: 100%; padding: 12px; border-radius: 8px; 
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.3); color: white;
            font-family: var(--font-main); margin-bottom: 15px;
        }
        input:focus, textarea:focus { border-color: var(--accent-primary); outline: none; }

        /* --- COOK MODE --- */
        .cook-step-container {
            padding: 30px 20px; text-align: center; min-height: 200px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .cook-step-text { font-size: 1.4rem; line-height: 1.6; }
        
        .meal-hint {
            background: var(--accent-secondary); color: #000; padding: 12px;
            border-radius: 8px; margin-bottom: 20px; font-weight: 800;
            display: flex; justify-content: space-between; align-items: center;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>BenKenHen Weekly Meal Planner</h1>
    </div>

    <div id="tab-planner" class="tab-content active">
        <div class="controls-row" style="justify-content: space-between; align-items: center;">
            <button class="pill-btn secondary" onclick="generateSmartShoppingList()" id="createListBtn">‚ú® Create Shopping List</button>
            <button style="background:none; border:none; text-decoration:underline; color:var(--text-muted); cursor:pointer; font-size:0.8rem;" onclick="clearMealPlan()">Clear Week</button>
        </div>
        <div id="plannerGrid"></div>
        <div style="height: 60px;"></div>
    </div>

    <div id="tab-recipes" class="tab-content">
        <div id="mealSelectionHint"></div>
        
        <div class="controls-row">
            <button class="pill-btn" onclick="toggleTagFilter()" id="tagFilterBtn">Filter</button>
            <button class="pill-btn secondary" onclick="surpriseMe()">Random</button>
        </div>

        <div id="tagFilterBox" class="glass-panel" style="display: none; padding: 15px; margin-bottom: 20px;">
            <div id="tagGrid" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>

        <div class="card-stack-container" id="cardStack"></div>
        <div style="text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 10px;" id="cardCounter"></div>
        
        <div class="card-nav">
            <button class="card-nav-btn" onclick="flipCard(-1)">‚Üê</button>
            <button class="card-nav-btn" onclick="flipCard(1)">‚Üí</button>
        </div>
    </div>

    <div id="tab-shopping" class="tab-content">
        <div class="glass-panel" style="padding: 15px; margin-bottom: 20px;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="customItem" placeholder="Add custom item..." style="margin-bottom:0;">
                <button onclick="addCustomItem()" style="background:var(--accent-primary); border:none; border-radius:8px; width:50px; font-size:1.5rem;">+</button>
            </div>
        </div>

        <div id="shoppingListContainer"></div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button style="background:none; border:none; text-decoration:underline; color:var(--accent-warm); cursor:pointer;" onclick="clearShoppingList()">Clear List</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('planner')" id="nav-planner">
            <span class="nav-icon">üìÖ</span> Plan
        </button>
        
        <button class="nav-btn" onclick="switchTab('recipes')" id="nav-recipes">
            <span class="nav-icon">üìñ</span> Recipes
        </button>
        
        <button class="nav-add-btn" onclick="openAddModal()">+</button>
        
        <button class="nav-btn" onclick="switchTab('shopping')" id="nav-shopping">
            <span class="nav-icon">üõí</span> Shop
            <span id="shopBadge" style="position:absolute; top:5px; right:15px; background:var(--accent-warm); width:8px; height:8px; border-radius:50%; display:none;"></span>
        </button>
        
        <button class="nav-btn" style="opacity:0; pointer-events:none; width:10px;"></button> </div>

    <div class="modal" id="recipeModal">
        <div class="modal-card glass-panel">
            <h2 style="margin-bottom:20px; color:var(--accent-primary);">New Recipe</h2>
            <button onclick="toggleVoiceInput()" id="voiceBtn" class="action-btn" style="background:var(--glass-bg); border:1px solid var(--glass-border); color:white; margin-bottom:15px;">
                üé§ Dictate Recipe
            </button>
            <div id="voiceStatus" style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-style:italic;"></div>

            <form onsubmit="saveRecipe(event)" id="recipeForm">
                <input id="inpTitle" placeholder="Title" required>
                <textarea id="inpDesc" rows="2" placeholder="Description (optional)"></textarea>
                <textarea id="inpIng" rows="4" placeholder="Ingredients (one per line)" required></textarea>
                <textarea id="inpInst" rows="4" placeholder="Instructions (one per line)" required></textarea>
                <input id="inpTags" placeholder="Tags (dinner, chicken, easy)">
                <button type="submit" class="action-btn">Save Card</button>
                <button type="button" onclick="closeAddModal()" style="width:100%; margin-top:10px; background:none; border:none; color:var(--text-muted);">Cancel</button>
            </form>
        </div>
    </div>

    <div class="modal" id="expandedModal">
        <div class="modal-card glass-panel" id="expandedContent"></div>
    </div>

    <div class="modal" id="selectorModal">
        <div class="modal-card glass-panel" style="max-width: 400px;">
            <h2 style="margin-bottom:15px; color:var(--accent-secondary); text-align:center;">Add to Plan</h2>
            <div id="selectorGrid" style="display:flex; flex-direction:column; gap:10px;"></div>
            <button onclick="closeSelectorModal()" style="width:100%; margin-top:15px; background:none; border:none; color:var(--text-muted); padding:10px;">Cancel</button>
        </div>
    </div>

    <div class="modal" id="cookModeModal">
        <div class="modal-card glass-panel" id="cookModeContent" style="max-width:600px; height:90vh; display:flex; flex-direction:column;"></div>
    </div>

    <script>
        // --- CONFIG ---
        const BIN_ID = "6947951243b1c97be9fc48e7"; 
        const JSONBIN_KEY = "$2a$10$qZdFvBQfv93zCuJiPDIln.ui9ln3pOufUtcpIivYnUQdJmakpBmWe";
        const AI_API_URL = "https://micas-recipe-api.ssccchef.workers.dev";
        
        // --- STATE ---
        let allRecipes = [];
        let filteredRecipes = [];
        let currentCardIndex = 0;
        let shoppingList = JSON.parse(localStorage.getItem('sarahShopList') || '[]');
        
        // Planner State: { "Monday": { "B": recipeId, "L": null, "D": recipeId }, ... }
        let mealPlan = JSON.parse(localStorage.getItem('sarahMealPlan') || '{}');
        
        // Selection State
        let pendingSlot = null; // { day: 'Monday', meal: 'L' }
        let targetRecipeForSelection = null; // For modal selection
        
        const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const MEALS = [
            { id: 'B', label: 'BRK' }, 
            { id: 'L', label: 'LUN' }, 
            { id: 'D', label: 'DIN' }
        ];

        // --- INIT ---
        async function init() {
            try {
                // Ensure planner structure is valid
                DAYS.forEach(day => {
                    if (!mealPlan[day]) mealPlan[day] = { B: null, L: null, D: null };
                });
                
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': JSONBIN_KEY } });
                const data = await res.json();
                allRecipes = Array.isArray(data.record) ? data.record : [];
                filteredRecipes = [...allRecipes];
                
                renderCardStack();
                renderPlanner();
                renderShopping();
                populateTags();
            } catch(e) {
                document.getElementById('cardStack').innerHTML = "<div style='text-align:center; padding:40px;'>Loaded offline mode (recipes may be missing).</div>";
            }
        }

        // --- PLANNER LOGIC ---
        function renderPlanner() {
            const grid = document.getElementById('plannerGrid');
            grid.innerHTML = DAYS.map(day => {
                const dayPlan = mealPlan[day] || { B: null, L: null, D: null };
                
                const slotsHtml = MEALS.map(meal => {
                    const recipeTitle = dayPlan[meal.id];
                    let content = `<button class="slot-empty-btn" onclick="selectForSlot('${day}', '${meal.id}')">+ Add ${meal.id === 'B' ? 'Breakfast' : meal.id === 'L' ? 'Lunch' : 'Dinner'}</button>`;
                    
                    if (recipeTitle) {
                        content = `
                            <div class="slot-filled" onclick="expandRecipeByTitle('${recipeTitle.replace(/'/g, "\\'")}')">${recipeTitle}</div>
                            <button class="slot-clear-btn" onclick="clearSlot('${day}', '${meal.id}')">√ó</button>
                        `;
                    }

                    return `
                        <div class="meal-slot-row">
                            <div class="slot-label">${meal.label}</div>
                            <div class="slot-content">${content}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="glass-panel meal-day-card">
                        <div class="meal-day-header">${day}</div>
                        ${slotsHtml}
                    </div>
                `;
            }).join('');
            
            // Save state whenever we render (simple sync)
            localStorage.setItem('sarahMealPlan', JSON.stringify(mealPlan));
        }

        function selectForSlot(day, mealId) {
            pendingSlot = { day, meal: mealId };
            switchTab('recipes');
            renderSelectionHint();
        }

        function clearSlot(day, mealId) {
            mealPlan[day][mealId] = null;
            renderPlanner();
        }

        function assignRecipeToSlot(recipeTitle) {
            if (!pendingSlot) return;
            mealPlan[pendingSlot.day][pendingSlot.meal] = recipeTitle;
            pendingSlot = null;
            renderSelectionHint();
            renderPlanner();
            switchTab('planner');
            
            // Close modal if open
            document.getElementById('expandedModal').classList.remove('show');
        }

        function renderSelectionHint() {
            const hintEl = document.getElementById('mealSelectionHint');
            if (pendingSlot) {
                const mealName = pendingSlot.meal === 'B' ? 'Breakfast' : pendingSlot.meal === 'L' ? 'Lunch' : 'Dinner';
                hintEl.innerHTML = `
                    <div class="meal-hint">
                        <span>Picking for ${pendingSlot.day} ${mealName}</span>
                        <button onclick="cancelSelection()" style="background:none; border:none; font-weight:800; cursor:pointer;">Cancel</button>
                    </div>`;
            } else {
                hintEl.innerHTML = '';
            }
        }

        function cancelSelection() {
            pendingSlot = null;
            renderSelectionHint();
        }

        function clearMealPlan() {
            if(confirm("Clear the entire week?")) {
                DAYS.forEach(day => mealPlan[day] = { B: null, L: null, D: null });
                renderPlanner();
            }
        }

        // --- SELECTOR MODAL LOGIC ---
        function openSelectorModal(recipeTitle) {
            targetRecipeForSelection = recipeTitle;
            const container = document.getElementById('selectorGrid');
            container.innerHTML = DAYS.map(day => `
                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <div style="font-weight:bold; margin-bottom:5px; color:var(--text-main); font-size:0.9rem;">${day}</div>
                    <div style="display:flex; gap:5px;">
                        ${MEALS.map(m => `
                            <button onclick="finalizeSelectionFromModal('${day}', '${m.id}')" 
                                style="flex:1; padding:10px 5px; background:var(--glass-bg); border:1px solid var(--glass-border); color:var(--text-muted); border-radius:6px; cursor:pointer; font-size:0.8rem;">
                                ${m.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('expandedModal').classList.remove('show');
            document.getElementById('selectorModal').classList.add('show');
        }

        function closeSelectorModal() {
            document.getElementById('selectorModal').classList.remove('show');
            targetRecipeForSelection = null;
        }

        function finalizeSelectionFromModal(day, mealId) {
            if(targetRecipeForSelection) {
                mealPlan[day][mealId] = targetRecipeForSelection;
                renderPlanner();
                closeSelectorModal();
                switchTab('planner');
            }
        }

        // --- CARD STACK LOGIC ---
        function renderCardStack() {
            const container = document.getElementById('cardStack');
            container.innerHTML = '';
            
            if (filteredRecipes.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:50px; color:var(--text-muted);">No recipes found</div>';
                document.getElementById('cardCounter').innerText = "";
                return;
            }

            for (let i = 0; i < Math.min(3, filteredRecipes.length); i++) {
                const rIdx = (currentCardIndex + i) % filteredRecipes.length;
                const r = filteredRecipes[rIdx];
                const card = document.createElement('div');
                card.className = 'recipe-card';
                card.dataset.pos = i;
                if (i === 0) card.onclick = () => expandRecipe(r);
                
                const tagsHtml = (r.tags || []).slice(0, 3).map(t => `<span class="card-tag">${t}</span>`).join('');
                
                card.innerHTML = `
                    <div class="card-content">
                        <div class="card-title">${r.title}</div>
                        <div style="margin-bottom:15px;">${tagsHtml}</div>
                        <div style="font-size:0.9rem; color:var(--text-muted); line-height:1.5; overflow:hidden; display:-webkit-box; -webkit-line-clamp:8; -webkit-box-orient:vertical;">
                            ${r.description || r.ingredients.slice(0,5).join(', ')}...
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }
            document.getElementById('cardCounter').innerText = `${currentCardIndex + 1} of ${filteredRecipes.length}`;
        }

        function flipCard(dir) {
            if (filteredRecipes.length < 2) return;
            currentCardIndex = (currentCardIndex + dir + filteredRecipes.length) % filteredRecipes.length;
            renderCardStack();
        }

        // --- EXPANDED RECIPE ---
        function expandRecipe(r) {
            const content = document.getElementById('expandedContent');
            const rId = r.title.replace(/'/g, "\\'");
            
            // Determine primary action button
            let actionBtn = `<button class="action-btn" onclick="openCookMode('${rId}')">üç≥ Start Cooking</button>`;
            
            if (pendingSlot) {
                const mealName = pendingSlot.meal === 'B' ? 'Breakfast' : pendingSlot.meal === 'L' ? 'Lunch' : 'Dinner';
                actionBtn = `<button class="action-btn" style="background:var(--accent-secondary);" onclick="assignRecipeToSlot('${rId}')">üìÖ Add to ${pendingSlot.day} ${mealName}</button>`;
            } else {
                // If not in selection mode, open the selector modal
                actionBtn += `<button class="action-btn secondary" style="margin-top:10px; background:none; border:1px solid var(--accent-secondary); color:var(--accent-secondary);" onclick="openSelectorModal('${rId}')">üìÖ Add to Plan</button>`;
            }

            content.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:15px;">
                    <h2 style="font-size:1.5rem; line-height:1.2;">${r.title}</h2>
                    <button onclick="document.getElementById('expandedModal').classList.remove('show')" style="background:none; border:none; font-size:1.5rem; color:var(--text-muted);">√ó</button>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h4 style="color:var(--accent-secondary); margin-bottom:8px;">Ingredients</h4>
                    <ul style="list-style:inside; color:var(--text-muted); font-size:0.9rem; line-height:1.6;">
                        ${r.ingredients.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="margin-bottom:20px;">
                    <h4 style="color:var(--accent-secondary); margin-bottom:8px;">Instructions</h4>
                    <ol style="list-style:inside; color:white; font-size:0.95rem; line-height:1.6;">
                        ${r.instructions.map(i => `<li style="margin-bottom:8px;">${i}</li>`).join('')}
                    </ol>
                </div>
                
                <div style="position:sticky; bottom:0; padding-top:15px; background:var(--bg-dark); border-top:1px solid var(--glass-border);">
                    ${actionBtn}
                </div>
            `;
            document.getElementById('expandedModal').classList.add('show');
        }

        function expandRecipeByTitle(title) {
            const r = allRecipes.find(x => x.title === title);
            if (r) expandRecipe(r);
        }

        // --- COOK MODE ---
        let cookStep = 0;
        let cookRecipe = null;

        function openCookMode(title) {
            cookRecipe = allRecipes.find(r => r.title === title);
            cookStep = 0;
            renderCookMode();
            document.getElementById('expandedModal').classList.remove('show');
            document.getElementById('cookModeModal').classList.add('show');
            // Wake lock attempt
            if (navigator.wakeLock) navigator.wakeLock.request('screen').catch(e=>{});
        }

        function renderCookMode() {
            const container = document.getElementById('cookModeContent');
            const step = cookRecipe.instructions[cookStep];
            const total = cookRecipe.instructions.length;
            
            container.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div>Step ${cookStep + 1}/${total}</div>
                    <button onclick="document.getElementById('cookModeModal').classList.remove('show')" style="background:none; border:none; color:white;">‚úï</button>
                </div>
                
                <div class="cook-step-container">
                    <div class="cook-step-text">${step}</div>
                </div>
                
                <div style="margin-top:auto; display:flex; gap:10px;">
                    <button class="action-btn secondary" onclick="changeCookStep(-1)" ${cookStep === 0 ? 'disabled style="opacity:0.3"' : ''}>Back</button>
                    <button class="action-btn" onclick="changeCookStep(1)">${cookStep === total - 1 ? 'Finish' : 'Next'}</button>
                </div>
                
                <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--glass-border);">
                    <details>
                        <summary style="cursor:pointer; color:var(--accent-secondary);">Show Ingredients</summary>
                        <ul style="margin-top:10px; font-size:0.9rem; color:var(--text-muted);">
                            ${cookRecipe.ingredients.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </details>
                </div>
            `;
        }

        function changeCookStep(dir) {
            cookStep += dir;
            if (cookStep >= cookRecipe.instructions.length) {
                document.getElementById('cookModeModal').classList.remove('show');
            } else {
                renderCookMode();
            }
        }

        // --- SHOPPING LIST & AI ---
        async function generateSmartShoppingList() {
            // Gather all ingredients
            let ingredients = [];
            Object.values(mealPlan).forEach(daySlot => {
                Object.values(daySlot).forEach(rTitle => {
                    if (rTitle) {
                        const r = allRecipes.find(x => x.title === rTitle);
                        if (r) ingredients = [...ingredients, ...r.ingredients];
                    }
                });
            });

            if (ingredients.length === 0) {
                alert("Add meals to your plan first!");
                return;
            }

            const btn = document.getElementById('createListBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "ü§ñ Analyzing...";
            btn.disabled = true;

            try {
                // Call Cloudflare AI Worker
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Convert these recipe ingredients into a consolidated shopping list JSON. Combine duplicates. Group by aisle (Produce, Dairy, etc). \nIngredients: ${ingredients.join(', ')}` 
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                // Basic clean up of AI response to get JSON
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const jsonList = JSON.parse(text);
                
                // Flatten to app format
                shoppingList = [];
                for (let aisle in jsonList) {
                    jsonList[aisle].forEach(item => {
                        shoppingList.push({ 
                            text: item.item || item, 
                            qty: item.qty || '', 
                            checked: false 
                        });
                    });
                }
                
                renderShopping();
                switchTab('shopping');
                updateShopBadge();
            } catch (e) {
                console.error(e);
                alert("AI generation failed. creating raw list.");
                shoppingList = ingredients.map(i => ({ text: i, checked: false }));
                renderShopping();
                switchTab('shopping');
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function renderShopping() {
            const container = document.getElementById('shoppingListContainer');
            if (shoppingList.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">List is empty</div>';
                return;
            }
            
            container.innerHTML = shoppingList.map((item, i) => `
                <div class="glass-panel shop-item ${item.checked ? 'checked' : ''}" onclick="toggleShopItem(${i})">
                    <div class="shop-checkbox"></div>
                    <div>
                        ${item.qty ? `<span style="color:var(--accent-primary); font-weight:bold; margin-right:5px;">${item.qty}</span>` : ''}
                        <span>${item.text}</span>
                    </div>
                </div>
            `).join('');
            
            localStorage.setItem('sarahShopList', JSON.stringify(shoppingList));
            updateShopBadge();
        }

        function toggleShopItem(i) {
            shoppingList[i].checked = !shoppingList[i].checked;
            renderShopping();
        }

        function addCustomItem() {
            const val = document.getElementById('customItem').value;
            if (val) {
                shoppingList.push({ text: val, checked: false });
                document.getElementById('customItem').value = '';
                renderShopping();
            }
        }

        function clearShoppingList() {
            shoppingList = [];
            renderShopping();
        }

        function updateShopBadge() {
            const count = shoppingList.filter(i => !i.checked).length;
            const badge = document.getElementById('shopBadge');
            if (count > 0) badge.style.display = 'block';
            else badge.style.display = 'none';
        }

        // --- UTILS ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');
            
            if (id !== 'recipes') cancelSelection();
        }

        function toggleTagFilter() {
            const box = document.getElementById('tagFilterBox');
            box.style.display = box.style.display === 'none' ? 'block' : 'none';
        }

        function populateTags() {
            const tags = new Set();
            allRecipes.forEach(r => (r.tags || []).forEach(t => tags.add(t)));
            const grid = document.getElementById('tagGrid');
            grid.innerHTML = Array.from(tags).map(t => 
                `<div class="card-tag" onclick="filterByTag('${t}')" style="cursor:pointer;">${t}</div>`
            ).join('');
        }

        function filterByTag(tag) {
            filteredRecipes = allRecipes.filter(r => (r.tags || []).includes(tag));
            currentCardIndex = 0;
            renderCardStack();
            document.getElementById('tagFilterBox').style.display = 'none';
        }

        function surpriseMe() {
            if (filteredRecipes.length > 0) {
                currentCardIndex = Math.floor(Math.random() * filteredRecipes.length);
                renderCardStack();
            }
        }

        // --- ADD/SAVE ---
        function openAddModal() { document.getElementById('recipeModal').classList.add('show'); }
        function closeAddModal() { document.getElementById('recipeModal').classList.remove('show'); }
        
        async function saveRecipe(e) {
            e.preventDefault();
            const newR = {
                title: document.getElementById('inpTitle').value,
                description: document.getElementById('inpDesc').value,
                ingredients: document.getElementById('inpIng').value.split('\n').filter(x=>x),
                instructions: document.getElementById('inpInst').value.split('\n').filter(x=>x),
                tags: document.getElementById('inpTags').value.split(',').map(x=>x.trim()).filter(x=>x)
            };
            
            allRecipes.push(newR);
            // Push to cloud
            fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
                body: JSON.stringify(allRecipes)
            });
            
            filteredRecipes = [...allRecipes];
            closeAddModal();
            renderCardStack();
        }

        // --- VOICE ---
        function toggleVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("Browser does not support voice");
            
            const recognition = new SpeechRecognition();
            recognition.onstart = () => document.getElementById('voiceStatus').innerText = "Listening...";
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById('voiceStatus').innerText = "Analyzing: " + transcript;
                // Simple parsing for demo
                document.getElementById('inpTitle').value = "New Voice Recipe";
                document.getElementById('inpDesc').value = transcript;
            };
            recognition.start();
        }

        init();
    </script>
</body>
</html>
